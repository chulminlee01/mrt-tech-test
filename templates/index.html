<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tech Test Generator | Myrealtrip</title>
  <style>
    /*
      Chosen Palette: Warm Neutrals & Subtle Accent
      - Background: #F7F9FC (Almost white, very light blue/gray)
      - Text: #1F2937 (Dark Slate)
      - Primary Accent: #059669 (Emerald Green for trust and growth)
      - Secondary/Cards: #FFFFFF (White) with soft shadows
    */
    
    :root {
      --bg-color: #F7F9FC;
      --text-color: #1F2937;
      --accent-color: #059669;
      --card-color: #FFFFFF;
      --light-accent: #E6F4F1;
      --gray-color: #6B7280;
      --slate-100: #f1f5f9;
      --slate-700: #334155;
      --emerald-50: #ecfdf5;
      --emerald-500: #10b981;
      --emerald-600: #059669;
      --emerald-700: #047857;
      --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
      --shadow: 0 1px 3px rgba(0,0,0,.1), 0 1px 2px rgba(0,0,0,.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: var(--card-color);
      box-shadow: var(--shadow);
      padding: 1rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header__container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .header__logo img {
      height: 32px;
      display: block;
    }
    
    .header__title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
    }
    
    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 1.5rem;
    }
    
    /* Hero Section */
    .hero {
      text-align: center;
      margin-bottom: 3rem;
    }
    
    .hero__title {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-color);
      margin-bottom: 0.75rem;
    }
    
    .hero__subtitle {
      font-size: 1.25rem;
      color: var(--gray-color);
      margin-bottom: 1rem;
    }
    
    .hero__badge {
      display: inline-block;
      background: var(--emerald-50);
      color: var(--accent-color);
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    /* Form Card */
    .form-card {
      background: var(--card-color);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      padding: 2.5rem;
      max-width: 600px;
      margin: 0 auto 2rem;
    }
    
    .form-card__title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    
    .form-group select,
    .form-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--slate-100);
      border-radius: 8px;
      font-size: 1rem;
      color: var(--text-color);
      background: var(--card-color);
      transition: all 0.2s ease;
    }
    
    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px var(--light-accent);
    }
    
    .btn {
      width: 100%;
      padding: 1rem 2rem;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
    }
    
    .btn:hover:not(:disabled) {
      background: var(--emerald-700);
      box-shadow: var(--shadow-lg);
      transform: translateY(-1px);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn--loading {
      position: relative;
      color: transparent;
    }
    
    .btn--loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Status Card */
    .status-card {
      background: var(--card-color);
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      padding: 2rem;
      max-width: 1000px;
      margin: 0 auto 2rem;
      display: none;
    }
    
    .status-card.visible {
      display: block;
    }
    
    /* Agent Team Display */
    .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .agent-card {
      background: var(--slate-100);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .agent-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gray-color);
      transition: all 0.3s ease;
    }
    
    .agent-card.pending {
      opacity: 0.6;
    }
    
    .agent-card.pending::before {
      background: var(--gray-color);
    }
    
    .agent-card.active {
      border-color: var(--accent-color);
      background: var(--emerald-50);
      box-shadow: 0 0 0 3px var(--light-accent);
      animation: pulse-border 2s ease-in-out infinite;
    }
    
    .agent-card.active::before {
      background: var(--accent-color);
      animation: shimmer 2s ease-in-out infinite;
    }
    
    .agent-card.reviewing {
      border-color: #f59e0b;
      background: #fef3c7;
    }
    
    .agent-card.reviewing::before {
      background: #f59e0b;
    }
    
    .agent-card.completed {
      border-color: var(--accent-color);
      background: var(--card-color);
    }
    
    .agent-card.completed::before {
      background: var(--accent-color);
    }
    
    @keyframes pulse-border {
      0%, 100% { box-shadow: 0 0 0 3px var(--light-accent); }
      50% { box-shadow: 0 0 0 6px var(--light-accent); }
    }
    
    .agent-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    .agent-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.25rem;
    }
    
    .agent-role {
      font-size: 0.75rem;
      color: var(--gray-color);
    }
    
    .agent-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: var(--accent-color);
      color: white;
      font-size: 0.65rem;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-weight: 600;
      display: none;
    }
    
    .agent-card.active .agent-badge {
      display: block;
      animation: bounce 1s ease-in-out infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }
    
    .discussion-phase {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      display: none;
    }
    
    .discussion-phase.visible {
      display: block;
      animation: slideIn 0.5s ease-out;
    }
    
    .discussion-phase.completed {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border-color: #16a34a;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .discussion-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .discussion-content {
      color: #78350f;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    .team-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .status-card__header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .status-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    
    .status-icon--running {
      background: var(--emerald-50) !important;
      color: var(--emerald-600) !important;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .status-icon--completed {
      background: var(--emerald-50) !important;
      color: var(--emerald-600) !important;
    }
    
    .status-icon--failed {
      background: #fee2e2 !important;
      color: #dc2626 !important;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .status-card__title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
    }
    
    .status-card__subtitle {
      color: var(--gray-color);
      font-size: 0.95rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--slate-100);
      border-radius: 9999px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .progress-bar__fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--emerald-500));
      border-radius: 9999px;
      transition: width 0.5s ease;
      animation: shimmer 2s ease-in-out infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .status-message {
      color: var(--gray-color);
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
    }
    
    /* Agent Activity Boxes - Fixed Grid */
    .activities-section {
      margin-top: 1.5rem;
      display: none !important;
    }
    
    .activities-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .activities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .activity-box {
      background: var(--card-color);
      border: 3px solid var(--slate-100);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      height: 220px;
      display: flex;
      flex-direction: column;
    }
    
    .activity-box:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    
    .activity-box.active {
      border-color: var(--accent-color);
      border-width: 3px;
      box-shadow: 0 0 0 4px var(--light-accent), var(--shadow-lg);
      animation: pulse-box 2s ease-in-out infinite;
    }
    
    .activity-box.completed {
      border-color: #10b981;
      opacity: 0.9;
    }
    
    @keyframes pulse-box {
      0%, 100% { box-shadow: 0 0 0 4px var(--light-accent), var(--shadow-lg); }
      50% { box-shadow: 0 0 0 8px var(--light-accent), var(--shadow-lg); }
    }
    
    .activity-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--slate-100);
    }
    
    .activity-icon {
      font-size: 2rem;
      line-height: 1;
    }
    
    .activity-agent-info {
      flex: 1;
      min-width: 0;
    }
    
    .activity-agent-name {
      font-weight: 700;
      color: var(--text-color);
      font-size: 0.95rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .activity-status-badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 9999px;
      font-weight: 600;
      background: var(--slate-100);
      color: var(--gray-color);
    }
    
    .activity-box.active .activity-status-badge {
      background: var(--accent-color);
      color: white;
      animation: pulse-badge 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .activity-summary {
      flex: 1;
      color: var(--text-color);
      font-size: 0.875rem;
      line-height: 1.5;
      overflow-y: auto;
      margin-bottom: 0.75rem;
      padding-right: 0.5rem;
    }
    
    .activity-summary::-webkit-scrollbar {
      width: 4px;
    }
    
    .activity-summary::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 2px;
    }
    
    .activity-empty {
      color: var(--gray-color);
      font-style: italic;
      font-size: 0.85rem;
    }
    
    /* Agent Message Formatting */
    .agent-message {
      margin: 0.5rem 0;
      padding: 0.5rem;
      border-left: 3px solid;
      background: rgba(0,0,0,0.02);
      border-radius: 4px;
    }
    
    .agent-message.pm {
      border-left-color: #8b5cf6;
      background: rgba(139, 92, 246, 0.05);
    }
    
    .agent-message.researcher {
      border-left-color: #0ea5e9;
      background: rgba(14, 165, 233, 0.05);
    }
    
    .agent-message.designer {
      border-left-color: #f59e0b;
      background: rgba(245, 158, 11, 0.05);
    }
    
    .agent-message.reviewer {
      border-left-color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }
    
    .agent-message.writer {
      border-left-color: #10b981;
      background: rgba(16, 185, 129, 0.05);
    }
    
    .agent-speaker {
      font-weight: 700;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-bottom: 0.25rem;
    }
    
    .agent-speaker-icon {
      font-size: 1rem;
    }
    
    .task-separator {
      border-top: 2px dashed var(--slate-100);
      margin: 0.75rem 0;
      padding-top: 0.75rem;
    }
    
    .task-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--accent-color);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    
    .activity-expand-hint {
      text-align: center;
      color: var(--accent-color);
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: auto;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--slate-100);
    }
    
    .activity-box:hover .activity-expand-hint {
      text-decoration: underline;
    }
    
    /* Expanded Activity Modal */
    .activity-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    
    .activity-modal.visible {
      display: flex;
    }
    
    .activity-modal-content {
      background: var(--card-color);
      border-radius: 16px;
      max-width: 700px;
      max-height: 80vh;
      width: 100%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,.3);
    }
    
    .activity-modal-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem;
      border-bottom: 2px solid var(--slate-100);
    }
    
    .activity-modal-icon {
      font-size: 2.5rem;
    }
    
    .activity-modal-title {
      flex: 1;
    }
    
    .activity-modal-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-color);
    }
    
    .activity-modal-role {
      font-size: 0.9rem;
      color: var(--gray-color);
    }
    
    .activity-modal-close {
      background: var(--slate-100);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .activity-modal-close:hover {
      background: var(--slate-700);
      color: white;
    }
    
    .activity-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      line-height: 1.6;
      white-space: pre-wrap;
      font-size: 0.95rem;
    }
    
    .activity-modal-body::-webkit-scrollbar {
      width: 8px;
    }
    
    .activity-modal-body::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 4px;
    }
    
    /* Agent Logs */
    .logs-section {
      margin-top: 1.5rem;
      border-top: 1px solid var(--slate-100);
      padding-top: 1.5rem;
    }
    
    .logs-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      cursor: pointer;
      user-select: none;
    }
    
    .logs-header:hover {
      color: var(--accent-color);
    }
    
    .logs-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: var(--text-color);
    }
    
    .logs-toggle {
      font-size: 1.25rem;
      transition: transform 0.3s ease;
    }
    
    .logs-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    .logs-container {
      background: var(--slate-700);
      border-radius: 8px;
      padding: 1rem;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
      font-size: 0.85rem;
      line-height: 1.5;
      color: #e5e7eb;
      display: none;
    }
    
    .logs-container.visible {
      display: block;
    }

    .timeline-section {
      margin-top: 1.5rem;
      background: var(--card-color);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: var(--shadow);
    }

    .timeline-title {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: space-between;
    }

    .timeline-title span:first-child {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .timeline-expand-btn {
      border: none;
      background: var(--slate-700);
      color: #fff;
      font-size: 0.85rem;
      padding: 0.35rem 0.75rem;
      border-radius: 9999px;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .timeline-expand-btn:hover {
      opacity: 0.85;
    }

    .timeline-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 640px;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .timeline-entry {
      display: flex;
      gap: 0.75rem;
      margin: 0 0.5rem;
      align-items: flex-start;
    }

    .timeline-entry.pm {
      flex-direction: row-reverse;
      justify-content: flex-end;
    }

    .timeline-icon {
      font-size: 1.4rem;
      line-height: 1;
      align-self: flex-start;
      margin-top: 0.35rem;
    }

    .timeline-body {
      flex: 1;
      min-width: 0;
      background: #1c2536;
      border-radius: 16px;
      padding: 0.85rem 1.1rem;
      box-shadow: 0 14px 38px rgba(15, 23, 42, 0.35);
      color: #e2e8f0;
    }

    .timeline-entry.pm .timeline-body {
      background: #111c2c;
      border: 1px solid rgba(16, 185, 129, 0.6);
    }

    .timeline-role-label {
      font-weight: 600;
      font-family: 'SFMono-Regular', ui-monospace, 'Roboto Mono', Menlo, monospace;
      color: #34d399;
      margin-bottom: 0.35rem;
      letter-spacing: 0.3px;
    }

    .timeline-entry.pm .timeline-role-label {
      color: #a5b4fc;
    }

    .timeline-entry.active .timeline-body {
      box-shadow: 0 18px 45px rgba(34, 197, 94, 0.35);
      border: 1px solid rgba(16, 185, 129, 0.55);
    }

    .timeline-time {
      font-weight: 500;
      font-size: 0.8rem;
      color: rgba(226, 232, 240, 0.85);
    }

    .timeline-text {
      font-size: 0.92rem;
      line-height: 1.6;
    }

    .timeline-detail {
      margin-top: 0.4rem;
      font-size: 0.85rem;
      color: #bac8f0;
      opacity: 0.95;
    }

    .timeline-thinking {
      margin-top: 0.45rem;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.85rem;
      color: #86efac;
    }

    .timeline-thinking span {
      width: 6px;
      height: 6px;
      border-radius: 9999px;
      background: currentColor;
      display: inline-block;
      animation: pulseDots 1s infinite ease-in-out;
    }

    .timeline-thinking span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .timeline-thinking span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes pulseDots {
      0%, 100% { opacity: 0.2; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-2px); }
    }

    .timeline-entry.task .timeline-body {
      background: #374151;
      border: 1px solid rgba(148, 163, 184, 0.35);
      text-align: center;
      font-style: italic;
      color: #f1f5f9;
    }
    
    .timeline-tool-badge {
      margin-top: 0.45rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      width: fit-content;
      padding: 0.2rem 0.65rem;
      border-radius: 9999px;
      border: 1px solid rgba(16, 185, 129, 0.5);
      background: rgba(16, 185, 129, 0.12);
      color: #6ee7b7;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    .long-task-banner {
      margin: 1rem 0 1.5rem;
      padding: 1rem 1.25rem;
      border-radius: 14px;
      border: 1px solid rgba(16, 185, 129, 0.35);
      background: rgba(5, 46, 22, 0.75);
      color: #bbf7d0;
      font-size: 0.9rem;
      box-shadow: 0 15px 38px rgba(6, 78, 59, 0.45);
      display: none;
      align-items: center;
      gap: 0.75rem;
    }

    .long-task-banner.visible {
      display: flex;
    }

    .long-task-spinner {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 9999px;
      border: 2px solid rgba(134, 239, 172, 0.4);
      border-top-color: #34d399;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes focusPulse {
      0% { transform: scale(1); box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.35); }
      50% { transform: scale(1.05); box-shadow: inset 0 0 0 2px rgba(16, 185, 129, 0.55); }
      100% { transform: scale(1); box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.35); }
    }

    @keyframes focusDots {
      from { width: 0ch; }
      to { width: 3ch; }
    }

    .agent-focus {
      display: none;
      margin: 1rem 0 2rem;
      padding: 1.2rem 1.5rem;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(16, 185, 129, 0.12));
      border: 1px solid rgba(59, 130, 246, 0.35);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.4);
      align-items: center;
      gap: 1rem;
    }

    .agent-focus.active {
      display: flex;
    }

    .agent-focus-icon {
      font-size: 2.2rem;
      width: 3.25rem;
      height: 3.25rem;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.45);
      transition: transform 0.3s ease;
    }

    .agent-focus.active .agent-focus-icon {
      animation: focusPulse 1.6s ease-in-out infinite;
    }

    .agent-focus-label {
      font-size: 0.95rem;
      letter-spacing: 0.3px;
      color: #bfdbfe;
      font-weight: 600;
    }

    .agent-focus-text {
      margin-top: 0.15rem;
      font-size: 0.9rem;
      color: #e0f2fe;
      position: relative;
      padding-right: 1.2rem;
    }

    .agent-focus-text::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      width: 0ch;
      overflow: hidden;
      color: #bae6fd;
    }

    .agent-focus.active .agent-focus-text::after {
      content: '...';
      animation: focusDots 1.4s steps(4, end) infinite;
    }

    .timeline-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      z-index: 1500;
      padding: 2rem;
      align-items: center;
      justify-content: center;
    }

    .timeline-modal.visible {
      display: flex;
    }

    .timeline-modal-content {
      background: #0f172a;
      border-radius: 18px;
      max-width: 900px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 65px rgba(15, 23, 42, 0.65);
    }

    .timeline-modal-header {
      padding: 1.5rem 1.75rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #e2e8f0;
    }

    .timeline-modal-body {
      padding: 1.5rem;
      overflow-y: auto;
      max-height: calc(80vh - 120px);
      padding-bottom: 3rem;
    }

    .timeline-modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(148, 163, 184, 0.2);
      color: #f8fafc;
      font-size: 1.15rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .timeline-modal-close:hover {
      background: rgba(148, 163, 184, 0.35);
    }
    
    .logs-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .logs-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    .logs-container::-webkit-scrollbar-thumb {
      background: var(--accent-color);
      border-radius: 4px;
    }
    
    .log-line {
      padding: 0.25rem 0;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .log-line.agent-thought {
      color: #60a5fa;
    }
    
    .log-line.agent-action {
      color: #34d399;
      font-weight: 600;
    }
    
    .log-line.agent-observation {
      color: #fbbf24;
    }
    
    .log-line.agent-final {
      color: #a78bfa;
      font-weight: 600;
    }
    
    .log-line.error {
      color: #f87171;
      font-weight: 600;
    }
    
    .log-line.success {
      color: #4ade80;
    }
    
    .logs-empty {
      color: var(--gray-color);
      font-style: italic;
      text-align: center;
      padding: 2rem;
    }
    
    .btn-secondary {
      background: var(--slate-100);
      color: var(--text-color);
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
    }
    
    .btn-secondary:hover {
      background: var(--slate-700);
      color: white;
    }
    
    .result-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: var(--accent-color);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .result-link:hover {
      background: var(--emerald-700);
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    /* Jobs List */
    .jobs-section {
      max-width: 900px;
      margin: 3rem auto 0;
    }
    
    .jobs-section__title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    
    .job-card {
      background: var(--card-color);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.2s ease;
    }
    
    .job-card:hover {
      box-shadow: var(--shadow-lg);
    }
    
    .job-card__header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.75rem;
    }
    
    .job-card__title {
      font-weight: 600;
      color: var(--text-color);
    }
    
    .job-card__badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .job-card__badge--completed {
      background: var(--emerald-50);
      color: var(--accent-color);
    }
    
    .job-card__badge--running {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .job-card__badge--failed {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .job-card__info {
      color: var(--gray-color);
      font-size: 0.875rem;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--gray-color);
      border-top: 1px solid var(--slate-100);
      margin-top: 4rem;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header__container">
      <a href='https://www.myrealtrip.com/' target='_blank' rel='noopener' class='header__logo' aria-label='Myrealtrip ÌôàÏúºÎ°ú Ïù¥Îèô'>
        <img src='https://cdn.prod.website-files.com/652cf379a649f747375f2efe/65b9f0d4c60108a9d95c20c2_%EB%B3%80%EA%B2%BD%ED%95%84%EC%9A%94)%EB%A7%88%EC%9D%B4%EB%A6%AC%EC%96%BC%ED%8A%B8%EB%A6%BD.jpg' alt='Myrealtrip Î°úÍ≥†'>
      </a>
      <h1 class="header__title">Tech Test Generator</h1>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Hero Section -->
    <div class="hero">
      <h1 class="hero__title">AI-Powered Tech Test Generator</h1>
      <p class="hero__subtitle">Create comprehensive coding assignments in minutes</p>
      <span class="hero__badge">ü§ñ Powered by NVIDIA DeepSeek & CrewAI</span>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <h2 class="form-card__title">Generate Tech Test</h2>
      <form id="generateForm">
        <div class="form-group">
          <label for="jobRole">Job Role *</label>
          <select id="jobRole" name="job_role" required>
            <option value="">Select a role...</option>
            <option value="iOS Developer">iOS Developer</option>
            <option value="Android Developer">Android Developer</option>
            <option value="Frontend Developer">Frontend Developer</option>
            <option value="Backend Developer">Backend Developer</option>
            <option value="Full Stack Developer">Full Stack Developer</option>
            <option value="Data Engineer">Data Engineer</option>
            <option value="ML Engineer">ML Engineer</option>
            <option value="DevOps Engineer">DevOps Engineer</option>
            <option value="QA Engineer">QA Engineer</option>
          </select>
        </div>

        <div class="form-group">
          <label for="jobLevel">Job Level *</label>
          <select id="jobLevel" name="job_level" required>
            <option value="">Select a level...</option>
            <option value="Junior">Junior</option>
            <option value="Mid-level">Mid-level</option>
            <option value="Senior">Senior</option>
            <option value="Principal">Principal</option>
            <option value="Staff">Staff</option>
          </select>
        </div>

        <div class="form-group">
          <label for="language">Language *</label>
          <select id="language" name="language" required>
            <option value="Korean">Korean (ÌïúÍµ≠Ïñ¥)</option>
            <option value="English">English</option>
            <option value="Japanese">Japanese (Êó•Êú¨Ë™û)</option>
            <option value="Chinese">Chinese (‰∏≠Êñá)</option>
          </select>
        </div>

        <button type="submit" class="btn" id="generateBtn">
          <span id="btnText">üöÄ Generate Tech Test</span>
        </button>
      </form>
    </div>

    <!-- Status Card -->
    <div class="status-card" id="statusCard">
      <div class="status-card__header">
        <div class="status-icon" id="statusIcon">‚ö°</div>
        <div>
          <h3 class="status-card__title" id="statusTitle">Generating...</h3>
          <p class="status-card__subtitle" id="statusSubtitle">Please wait</p>
        </div>
      </div>
      
      <div class="progress-bar">
        <div class="progress-bar__fill" id="progressBar" style="width: 0%"></div>
      </div>
      
      <p class="status-message" id="statusMessage">Initializing agents...</p>
      
      <div style="text-align: center; margin-bottom: 1rem;">
        <small style="color: var(--gray-color); font-family: monospace;">
          Job ID: <span id="jobIdDisplay">-</span>
        </small>
      </div>
      
      <!-- CrewAI Team Display -->
      <div class="team-section-title">ü§ñ CrewAI Team Status</div>
      <div class="agents-grid" id="agentsGrid">
        <!-- Agents will be populated here -->
      </div>
      
      <!-- Discussion Phase -->
      <div class="discussion-phase" id="discussionPhase">
        <div class="discussion-title">
          <span>üí¨</span>
          <span id="discussionTitleText">Team Discussion in Progress</span>
        </div>
        <div class="discussion-content" id="discussionContent">
          Agents are collaborating and reviewing outputs...
        </div>
      </div>
      
      <div class="timeline-section">
        <div class="timeline-title">
          <span>üïí Crew Discussion Timeline</span>
          <button class="timeline-expand-btn" onclick="openTimelineModal()">View Full Discussion</button>
            </div>
        <div class="timeline-list" id="timelineList">
          <div class="timeline-entry">
            <div class="timeline-icon">‚ÑπÔ∏è</div>
            <div class="timeline-body">
              <div class="timeline-role-label">[System]</div>
              <div class="timeline-text">Timeline will appear as soon as the crew starts collaborating.</div>
          </div>
          </div>
        </div>
      </div>
      
      <div class="agent-focus" id="agentFocus">
        <div class="agent-focus-icon" id="agentFocusIcon">ü§ñ</div>
        <div>
          <div class="agent-focus-label" id="agentFocusLabel">Waiting for crew activity‚Ä¶</div>
          <div class="agent-focus-text" id="agentFocusText">Agents will appear here while they are thinking.</div>
        </div>
      </div>

      <div class="long-task-banner" id="longTaskBanner">
        <div class="long-task-spinner"></div>
        <div id="longTaskText">Finalizing deliverables. This may take a minute‚Ä¶</div>
        </div>
      
      <div class="timeline-modal" id="timelineModal">
        <div class="timeline-modal-content">
          <div class="timeline-modal-header">
            <div>üóÇÔ∏è Full Crew Discussion</div>
            <button class="timeline-modal-close" onclick="closeTimelineModal()">√ó</button>
        </div>
          <div class="timeline-modal-body" id="timelineModalBody">
          </div>
        </div>
      </div>
      
      <!-- Agent Logs Section (Collapsed by Default) -->
      <div class="logs-section">
        <div class="logs-header" onclick="toggleLogs()">
          <div class="logs-title">
            <span>ü§ñ</span>
            <span>Agent Discussion & Analysis</span>
            <span class="logs-toggle" id="logsToggle">‚ñº</span>
          </div>
        </div>
        <div class="logs-container visible" id="logsContainer">
          <div class="logs-empty" id="logsEmpty">Waiting for agents to start...</div>
        </div>
      </div>
      
      <div id="statusActions" style="text-align: center; display: none;">
        <a href="#" id="resultLink" class="result-link" target="_blank">
          üìÑ View Generated Tech Test
        </a>
      </div>
    </div>

    <!-- Recent Jobs -->
    <div class="jobs-section" id="jobsSection" style="display: none;">
      <h2 class="jobs-section__title">Recent Generations</h2>
      <div id="jobsList"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>¬© 2025 Myrealtrip. All Rights Reserved.</p>
    <p style="margin-top: 0.5rem; font-size: 0.875rem;">
      Powered by NVIDIA AI, Google Custom Search, and LangChain
    </p>
  </footer>

  <script>
    let currentJobId = null;
    let statusInterval = null;
    let logsInterval = null;
    let lastLogCount = 0;
    let timelineEntries = [];
    const MAX_TIMELINE_ENTRIES = 40;
    const timelineRoles = [
      { id: 'pm', label: 'Product Manager', icon: 'üëî', keywords: ['[pm]', 'product manager'] },
      { id: 'researcher', label: 'Research Analyst', icon: 'üîç', keywords: ['[research', 'research analyst'] },
      { 
        id: 'designer', 
        label: 'Assignment Generator', 
        icon: '‚úèÔ∏è', 
        keywords: [
          '[designer', 
          'assignment designer', 
          'assignment generator', 
          'generating assignments', 
          'generating detailed assignments', 
          'assignments generated'
        ] 
      },
      { id: 'data', label: 'Data Provider', icon: 'üìä', keywords: ['[data provider]', 'data provider', 'dataset'] },
      { id: 'builder', label: 'Web Builder', icon: 'üåê', keywords: ['[web builder]', 'web builder', 'portal'] },
      { id: 'styler', label: 'Web Designer', icon: 'üé®', keywords: ['[web designer]', 'styling', 'branding'] },
      { id: 'qa', label: 'QA Reviewer', icon: 'üîé', keywords: ['[qa', 'qa reviewer', 'approved'] }
    ];
    let activeAgentId = null;
    let longTaskActive = false;
    let backendActiveAgentId = null;
    const AGENT_FOCUS_HOLD_MS = 4500;
    let lastAgentFocusId = null;
    let agentFocusHideTimer = null;
    const timelineModal = document.getElementById('timelineModal');
    const timelineModalBody = document.getElementById('timelineModalBody');
    const discussionTitleText = document.getElementById('discussionTitleText');
    const longTaskBanner = document.getElementById('longTaskBanner');
    const longTaskText = document.getElementById('longTaskText');
    const agentFocus = document.getElementById('agentFocus');
    const agentFocusIcon = document.getElementById('agentFocusIcon');
    const agentFocusLabel = document.getElementById('agentFocusLabel');
    const agentFocusText = document.getElementById('agentFocusText');
    
    function resetAgentFocus() {
      lastAgentFocusId = null;
      if (agentFocusHideTimer) {
        clearTimeout(agentFocusHideTimer);
        agentFocusHideTimer = null;
      }
      updateAgentFocus(null);
    }
    
    // Agent definitions (7 agents: 4 CrewAI + 3 post-processing)
    const agents = [
      {id: "pm", name: "Product Manager", icon: "üëî", role: "Team Leader & Coordinator"},
      {id: "researcher", name: "Research Analyst", icon: "üîç", role: "Industry Research"},
      {id: "designer", name: "Assignment Generator", icon: "‚úèÔ∏è", role: "Challenge Creation"},
      {id: "reviewer", name: "QA Reviewer", icon: "üîé", role: "Quality Assurance"},
      {id: "data", name: "Data Provider", icon: "üìä", role: "Dataset Generation"},
      {id: "builder", name: "Web Builder", icon: "üåê", role: "Portal Creation"},
      {id: "styler", name: "Web Designer", icon: "üé®", role: "Styling & Design"}
    ];
    const agentFocusMessages = {
      pm: {
        label: "PM coordinating next steps",
        text: "PM is steering team approvals and making decisions."
      },
      researcher: {
        label: "Research Analyst investigating",
        text: "Collecting best practices and industry signals."
      },
      designer: {
        label: "Assignment Generator crafting scenarios",
        text: "Designing realistic multi-step challenges. This step can take up to a minute."
      },
      reviewer: {
        label: "QA Reviewer validating outputs",
        text: "Double-checking that every deliverable meets expectations."
      },
      data: {
        label: "Data Provider building datasets",
        text: "Synthesizing OTA-friendly datasets for the assignment."
      },
      builder: {
        label: "Web Builder assembling portal",
        text: "Packing assignments and resources into a clean candidate portal."
      },
      styler: {
        label: "Web Designer polishing UI",
        text: "Applying Myrealtrip styling and layout refinements."
      }
    };

    // Form submission
    document.getElementById('generateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      console.log('üöÄ Form submitted');
      
      const formData = {
        job_role: document.getElementById('jobRole').value,
        job_level: document.getElementById('jobLevel').value,
        language: document.getElementById('language').value
      };
      
      console.log('üìã Form data:', formData);

      // Validate
      if (!formData.job_role || !formData.job_level) {
        alert('Please fill in all required fields');
        console.error('‚ùå Validation failed - missing fields');
        return;
      }

      // Disable form
      const btn = document.getElementById('generateBtn');
      btn.disabled = true;
      btn.classList.add('btn--loading');
      console.log('üîÑ Button disabled, making API call...');

      try {
        console.log('üì° Calling /api/generate...');
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        console.log('üì° Response status:', response.status);
        const result = await response.json();
        console.log('üì° Response data:', result);

        if (result.success) {
          console.log('‚úÖ Generation started successfully');
          currentJobId = result.job_id;
          console.log('üÜî Job ID:', currentJobId);
          document.getElementById('jobIdDisplay').textContent = currentJobId;
          showStatusCard();
          startStatusPolling();
        } else {
          console.error('‚ùå Generation failed:', result.error);
          alert('Error: ' + result.error);
          resetForm();
        }
      } catch (error) {
        console.error('‚ùå Exception:', error);
        alert('Error: ' + error.message + '\n\nCheck browser console (F12) for details');
        resetForm();
      }
    });

    function initializeAgents() {
      const grid = document.getElementById('agentsGrid');
      grid.innerHTML = agents.map(agent => `
        <div class="agent-card pending" id="agent-${agent.id}" data-agent-id="${agent.id}">
          <span class="agent-badge">ACTIVE</span>
          <span class="agent-icon">${agent.icon}</span>
          <div class="agent-name">${agent.name}</div>
          <div class="agent-role">${agent.role}</div>
        </div>
      `).join('');
    }

    function updateAgentStatus(agentId, status) {
      const card = document.getElementById(`agent-${agentId}`);
      if (!card) return;
      
      // Remove all status classes
      card.classList.remove('pending', 'active', 'reviewing', 'completed');
      
      // Add new status class
      const allowedStatuses = ['pending', 'active', 'reviewing', 'completed'];
      const appliedStatus = allowedStatuses.includes(status) ? status : 'pending';
      card.classList.add(appliedStatus);
    }
    
    function applyAgentStatuses(statusMap) {
      if (!statusMap || typeof statusMap !== 'object') return;
      agents.forEach(agent => {
        const state = statusMap[agent.id] || 'pending';
        updateAgentStatus(agent.id, state);
      });
    }
    
    function setActiveAgent(agentId, source = 'logs', contextText = '') {
      if (source === 'status') {
        backendActiveAgentId = agentId || null;
      } else if (backendActiveAgentId && backendActiveAgentId !== agentId) {
        return;
      }
      
      const resolvedId = agentId || backendActiveAgentId || lastAgentFocusId;
      if (activeAgentId === resolvedId && contextText === '') {
        return;
      }
      
      activeAgentId = resolvedId || null;
      if (resolvedId) {
        lastAgentFocusId = resolvedId;
        if (agentFocusHideTimer) {
          clearTimeout(agentFocusHideTimer);
          agentFocusHideTimer = null;
        }
        updateAgentFocus(resolvedId, contextText);
      } else if (!agentFocusHideTimer) {
        agentFocusHideTimer = setTimeout(() => {
          lastAgentFocusId = null;
          updateAgentFocus(null);
          agentFocusHideTimer = null;
        }, AGENT_FOCUS_HOLD_MS);
      }
      renderTimeline();
      if (timelineModal && timelineModal.classList.contains('visible')) {
        renderTimelineModal();
      }
    }

    function updateAgentFocus(agentId, progressText = '') {
      if (!agentFocus || !agentFocusIcon || !agentFocusLabel || !agentFocusText) return;
      if (!agentId) {
        agentFocus.classList.remove('active');
        agentFocusIcon.textContent = 'ü§ñ';
        agentFocusLabel.textContent = 'Waiting for crew activity‚Ä¶';
        agentFocusText.textContent = 'Agents will appear here while they are thinking.';
        return;
      }

      const agentInfo = agents.find(a => a.id === agentId);
      if (!agentInfo) return;

      const focusData = agentFocusMessages[agentId] || {
        label: `${agentInfo.name} in progress`,
        text: 'This agent is actively working on their task.'
      };

      agentFocus.classList.add('active');
      agentFocusIcon.textContent = agentInfo.icon;
      agentFocusLabel.textContent = focusData.label;

      let detail = focusData.text;
      if (progressText) {
        const lower = progressText.toLowerCase();
        const nameToken = agentInfo.name.split(' ')[0].toLowerCase();
        const roleToken = (agentInfo.role || '').split(' ')[0].toLowerCase();
        if (lower.includes(nameToken) || lower.includes(roleToken) || lower.includes(agentId)) {
          detail = progressText;
        }
      }
      agentFocusText.textContent = detail;
    }

    
    function detectActiveAgent(logs) {
      if (!logs || logs.length === 0) return null;
      
      // Check recent logs to determine active agent
      const recentLogs = logs.slice(-5).join(' ').toLowerCase();
      
      if (recentLogs.includes('research analyst') || recentLogs.includes('searching google cse') || 
          recentLogs.includes('google_cse_search')) {
        return 'researcher';
      } else if (
        recentLogs.includes('assignment designer') ||
        recentLogs.includes('assignment generator') ||
        recentLogs.includes('generating assignments') ||
        recentLogs.includes('generating detailed assignments') ||
        recentLogs.includes('assignments generated') ||
        recentLogs.includes('creating assignment')
      ) {
        return 'designer';
      } else if (recentLogs.includes('qa reviewer') || recentLogs.includes('reviewing quality')) {
        return 'reviewer';
      } else if (recentLogs.includes('data provider') || recentLogs.includes('generated dataset') || recentLogs.includes('generating datasets')) {
        return 'data';
      } else if (recentLogs.includes('starter code') || recentLogs.includes('generating starter')) {
        return 'designer';  // Starter code phase uses designer context
      } else if (recentLogs.includes('web builder') || recentLogs.includes('building web portal') || recentLogs.includes('web page generated')) {
        return 'builder';
      } else if (recentLogs.includes('web designer') || recentLogs.includes('applying custom styling') || recentLogs.includes('css saved')) {
        return 'styler';
      } else if (recentLogs.includes('product manager') || recentLogs.includes('[pm]')) {
        return 'pm';
      }
      
      return null; // No specific agent active
    }
    
    function detectActiveAgentFromLogs(messages) {
      if (!messages || messages.length === 0) return null;
      
      const recent = messages.slice(-3).join(' ').toLowerCase();
      
      if (recent.includes('research') || recent.includes('searching')) return 'researcher';
      if (recent.includes('designer') || recent.includes('creating')) return 'designer';
      if (recent.includes('reviewer') || recent.includes('reviewing')) return 'reviewer';
      
      return null;
    }

    function showDiscussionPhase(logs) {
      if (!logs) return false;
      
      const allLogs = logs.join(' ').toLowerCase();
      const isDiscussing = allLogs.includes('review') || 
                          allLogs.includes('feedback') || 
                          allLogs.includes('revision') ||
                          allLogs.includes('discussion');
      
      const phase = document.getElementById('discussionPhase');
      if (isDiscussing && !phase.classList.contains('visible')) {
        phase.classList.add('visible');
        
        // Update discussion content based on what's happening
        let content = 'Agents are collaborating and reviewing outputs...';
        if (allLogs.includes('quality review')) {
          content = 'üîé QA Reviewer is examining assignments for quality and completeness...';
        } else if (allLogs.includes('documentation review')) {
          content = 'üìù Technical Writer is reviewing documentation clarity...';
        } else if (allLogs.includes('final coordination')) {
          content = 'üëî PM is coordinating final team sign-off and delivery...';
        }
        
        document.getElementById('discussionContent').textContent = content;
      }
      
      return isDiscussing;
    }

    function showStatusCard() {
      document.getElementById('statusCard').classList.add('visible');
      document.querySelector('.form-card').style.display = 'none';
      
      // Initialize agent cards
      initializeAgents();
      
      // Reset logs
      lastLogCount = 0;
      const container = document.getElementById('logsContainer');
      container.innerHTML = '<div class="logs-empty" id="logsEmpty">Waiting for agents to start...</div>';
      container.classList.remove('visible');  // Start collapsed
      document.getElementById('logsToggle').classList.add('collapsed');
      timelineEntries = [];
      renderTimeline();
      renderTimelineModal();
      hideLongTaskBanner();
      resetAgentFocus();

      const discussionPhase = document.getElementById('discussionPhase');
      if (discussionPhase) {
        discussionPhase.classList.add('visible');
        discussionPhase.classList.remove('completed');
      }
      if (discussionTitleText) {
        discussionTitleText.textContent = 'Team Discussion in Progress';
      }
      const discussionContent = document.getElementById('discussionContent');
      if (discussionContent) {
        discussionContent.textContent = 'Agents are collaborating and reviewing outputs...';
      }
      const actions = document.getElementById('statusActions');
      if (actions) {
        actions.style.display = 'none';
      }
    }
    

    function startStatusPolling() {
      // Clear any existing intervals
      if (statusInterval) {
        clearInterval(statusInterval);
      }
      if (logsInterval) {
        clearInterval(logsInterval);
      }

      // Poll status every 2 seconds
      statusInterval = setInterval(checkStatus, 2000);
      checkStatus(); // Check immediately
      
      // Poll logs every 1 second for real-time updates
      logsInterval = setInterval(fetchLogs, 1000);
      fetchLogs(); // Check immediately
    }

    async function checkStatus() {
      if (!currentJobId) return;

      try {
        const response = await fetch(`/api/status/${currentJobId}`);
        
        // Handle 404 gracefully - job might not be initialized yet
        if (response.status === 404) {
          console.log(`Job ${currentJobId} not found yet, waiting...`);
          return;
        }
        
        const result = await response.json();

        if (result.success) {
          updateStatusUI(result.status);

          if (result.status.status === 'completed' || result.status.status === 'failed') {
            clearInterval(statusInterval);
            clearInterval(logsInterval);
            loadRecentJobs();
          }
        }
      } catch (error) {
        console.error('Status check error:', error);
      }
    }

    async function fetchLogs() {
      if (!currentJobId) return;

      try {
        const response = await fetch(`/api/logs/${currentJobId}`);
        
        // Handle 404 gracefully - job might not be initialized yet
        if (response.status === 404) {
          return;
        }
        
        const result = await response.json();

        if (result.success && result.logs && result.logs.length > 0) {
          if (result.count > lastLogCount) {
            const previousCount = lastLogCount;
            displayLogs(result.logs, previousCount);
            lastLogCount = result.count;
          }
        }
      } catch (error) {
        console.error('Logs fetch error:', error);
      }
    }

    function displayLogs(logs, previousCount = 0) {
      const container = document.getElementById('logsContainer');
      const emptyMsg = document.getElementById('logsEmpty');
      
      if (emptyMsg) {
        emptyMsg.remove();
      }

      // Clear container if starting fresh
      if (previousCount === 0) {
        container.innerHTML = '';
      }

      // Add new log lines
      const newLogLines = logs.slice(previousCount);
      newLogLines.forEach(log => {
        const logLine = document.createElement('div');
        logLine.className = 'log-line';
        
        // Apply syntax highlighting based on content
        if (log.includes('Thought:') || log.includes('I need to') || log.includes('I should')) {
          logLine.classList.add('agent-thought');
        } else if (log.includes('Action:') || log.includes('Tool:') || log.includes('üîç Searching')) {
          logLine.classList.add('agent-action');
        } else if (log.includes('Observation:') || log.includes('‚úÖ Found')) {
          logLine.classList.add('agent-observation');
        } else if (log.includes('Final Answer:') || log.includes('Generation complete')) {
          logLine.classList.add('agent-final');
        } else if (log.includes('Error') || log.includes('error') || log.includes('‚ùå')) {
          logLine.classList.add('error');
        } else if (log.includes('‚úÖ') || log.includes('saved')) {
          logLine.classList.add('success');
        }
        
        logLine.textContent = log;
        container.appendChild(logLine);
      });

      // Auto-scroll to bottom
      container.scrollTop = container.scrollHeight;
      updateTimelineEntries(newLogLines);
      updateLongTaskBanner(newLogLines);
      
      // Update active agent for timeline indicator (fallback if backend hasn't updated yet)
      const activeAgent = detectActiveAgent(logs);
      if (!backendActiveAgentId) {
        const contextLine = newLogLines[newLogLines.length - 1] || '';
        setActiveAgent(activeAgent || null, 'logs', contextLine);
      }
      
      // Show discussion phase if detected
      showDiscussionPhase(logs);
    }

    function toggleLogs() {
      const container = document.getElementById('logsContainer');
      const toggle = document.getElementById('logsToggle');
      
      if (container.classList.contains('visible')) {
        container.classList.remove('visible');
        toggle.classList.add('collapsed');
      } else {
        container.classList.add('visible');
        toggle.classList.remove('collapsed');
        // Scroll to bottom when expanding
        container.scrollTop = container.scrollHeight;
      }
    }

    function ensureDiscussionPhaseVisible() {
      const phase = document.getElementById('discussionPhase');
      if (phase && !phase.classList.contains('visible')) {
        phase.classList.add('visible');
      }
    }

    function updateStatusUI(status) {
      const icon = document.getElementById('statusIcon');
      const title = document.getElementById('statusTitle');
      const subtitle = document.getElementById('statusSubtitle');
      const message = document.getElementById('statusMessage');
      const progressBar = document.getElementById('progressBar');
      const actions = document.getElementById('statusActions');
      const resultLink = document.getElementById('resultLink');

      const discussionPhase = document.getElementById('discussionPhase');
      const discussionContent = document.getElementById('discussionContent');
      const backendAgentStatusMap = status.agent_status || {};

      if (status.status === 'running' || status.status === 'initializing') {
        ensureDiscussionPhaseVisible();
        icon.className = 'status-icon status-icon--running';
        icon.textContent = '‚ö°';
        title.textContent = 'Generating...';
        subtitle.textContent = 'This may take 4-6 minutes';
        message.textContent = status.progress || 'Processing...';
        progressBar.style.width = '60%';
        actions.style.display = 'none';
        if (discussionPhase) {
          discussionPhase.classList.remove('completed');
        }
        if (discussionTitleText) {
          discussionTitleText.textContent = 'Team Discussion in Progress';
        }
        if (discussionContent) {
          discussionContent.textContent = status.progress || 'Agents are collaborating and reviewing outputs...';
        }
      } else if (status.status === 'completed') {
        hideLongTaskBanner();
        resetAgentFocus();
        ensureDiscussionPhaseVisible();
        icon.className = 'status-icon status-icon--completed';
        icon.textContent = '‚úÖ';
        title.textContent = 'Generation Complete!';
        subtitle.textContent = 'Your tech test is ready';
        message.textContent = status.progress || 'Successfully generated all assets including research, assignments, datasets, starter code, and portal.';
        progressBar.style.width = '100%';
        subtitle.textContent = 'üéâ Portal approved and ready for candidates!';
        
        let portalLink = status.index_url || '';
        if (!portalLink && status.output_dir) {
          const dirName = status.output_dir.split('/').pop();
          if (dirName) {
            portalLink = `/output/${dirName}/index.html`;
          }
        }
        if (portalLink) {
          if (typeof window !== 'undefined' && portalLink.startsWith('/')) {
            const origin = window.location.origin.replace(/\/$/, '');
            portalLink = `${origin}${portalLink}`;
          }
          resultLink.href = portalLink;
          resultLink.textContent = status.portal_ready
            ? 'üìÑ Open Generated Tech Test'
            : 'üìÅ View Generated Assets';
          actions.style.display = 'block';
        } else {
          actions.style.display = 'none';
          resultLink.removeAttribute('href');
        }
        if (discussionPhase) {
          discussionPhase.classList.add('completed');
        }
        if (discussionTitleText) {
          discussionTitleText.textContent = 'Team Discussion Completed';
        }
        if (discussionContent) {
          discussionContent.textContent = 'Discussion closed. All findings and deliverables are finalized.';
        }
      } else if (status.status === 'failed') {
        hideLongTaskBanner();
        resetAgentFocus();
        ensureDiscussionPhaseVisible();
        activeAgentId = null;
        icon.className = 'status-icon status-icon--failed';
        icon.textContent = '‚ùå';
        title.textContent = 'Generation Failed';
        subtitle.textContent = 'An error occurred';
        message.textContent = status.error || 'Unknown error';
        progressBar.style.width = '0%';
        actions.style.display = 'none';
        if (discussionPhase) {
          discussionPhase.classList.remove('completed');
        }
        if (discussionTitleText) {
          discussionTitleText.textContent = 'Team Discussion Interrupted';
        }
        if (discussionContent) {
          discussionContent.textContent = status.error || 'The crew encountered an error. Please review logs and retry.';
        }
      }
      
      if (status.status === 'completed') {
        const completedMap = {};
        agents.forEach(agent => { completedMap[agent.id] = 'completed'; });
        applyAgentStatuses(completedMap);
      } else if (backendAgentStatusMap && Object.keys(backendAgentStatusMap).length > 0) {
        applyAgentStatuses(backendAgentStatusMap);
      }
      
      setActiveAgent(status.active_agent || null, 'status', status.progress || '');
    }

    async function loadRecentJobs() {
      try {
        const response = await fetch('/api/jobs');
        const result = await response.json();

        if (result.success && result.jobs.length > 0) {
          const jobsSection = document.getElementById('jobsSection');
          const jobsList = document.getElementById('jobsList');
          
          jobsList.innerHTML = result.jobs.slice(0, 5).map(job => `
            <div class="job-card">
              <div class="job-card__header">
                <div class="job-card__title">${job.started_at ? new Date(job.started_at).toLocaleString() : 'N/A'}</div>
                <span class="job-card__badge job-card__badge--${job.status}">${job.status}</span>
              </div>
              <div class="job-card__info">${job.progress}</div>
              ${job.index_url ? `<a href="${job.index_url}" target="_blank" class="result-link" style="margin-top: 0.75rem; display: inline-flex;">View Result</a>` : ''}
            </div>
          `).join('');
          
          jobsSection.style.display = 'block';
        }
      } catch (error) {
        console.error('Failed to load jobs:', error);
      }
    }

    function resetForm() {
      const btn = document.getElementById('generateBtn');
      btn.disabled = false;
      btn.classList.remove('btn--loading');
    }

    function normalizeMessage(msg) {
      if (!msg) return '';
      return msg.trim().replace(/\\s+/g, ' ').replace(/[\\p{Punct}]/gu, '').toLowerCase();
    }

    function updateTimelineEntries(newLogs) {
      if (!newLogs || newLogs.length === 0) return;
      newLogs.forEach(log => {
        const entry = buildTimelineEntry(log);
        if (!entry) return;
        const lastEntry = timelineEntries[timelineEntries.length - 1];
        if (
          lastEntry &&
          lastEntry.roleId === entry.roleId &&
          lastEntry.type === entry.type &&
          normalizeMessage(lastEntry.message) === normalizeMessage(entry.message)
        ) {
          return;
        }
        // Also check previous one to avoid rapid duplicates
        const prevEntry = timelineEntries[timelineEntries.length - 2];
        if (
          prevEntry &&
          prevEntry.roleId === entry.roleId &&
          prevEntry.type === entry.type &&
          normalizeMessage(prevEntry.message) === normalizeMessage(entry.message)
        ) {
          return;
        }
        timelineEntries.push(entry);
      });
      if (timelineEntries.length > MAX_TIMELINE_ENTRIES) {
        timelineEntries = timelineEntries.slice(-MAX_TIMELINE_ENTRIES);
      }
      renderTimeline();
      if (timelineModal && timelineModal.classList.contains('visible')) {
        renderTimelineModal();
      }
    }

    function buildTimelineEntry(log) {
      if (!log) return null;
      const normalized = log.toLowerCase();
      if (normalized.includes('[api]') || normalized.includes('status check')) {
        return null;
      }

      const isTaskAnnouncement =
        normalized.startsWith('task:') ||
        normalized.startsWith('new task:') ||
        normalized.includes('task: ') ||
        normalized.startsWith('phase');

      if (isTaskAnnouncement) {
        const taskMessage = formatTaskMessage(log);
        if (!taskMessage) return null;
        return {
          icon: 'üìù',
          role: 'Task Update',
          roleId: 'task',
          message: taskMessage,
          detail: '',
          time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          type: 'task'
        };
      }

      const roleMatch = timelineRoles.find(role =>
        role.keywords.some(keyword => normalized.includes(keyword))
      );
      if (!roleMatch) return null;
      const message = formatTimelineMessage(log);
      if (!message) return null;
      const detail = formatTimelineDetail(log);
      const toolName = /google\s+cse|google_cse|google search tool/i.test(normalized) ? 'Google CSE' : null;
      return {
        icon: roleMatch.icon,
        role: roleMatch.label,
        roleId: roleMatch.id,
        message,
        detail: detail === message ? '' : detail,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        type: 'chat',
        toolName
      };
    }

    function formatTimelineMessage(text) {
      if (!text) return '';
      let cleaned = stripThinkBlocks(text);
      cleaned = cleaned.replace(/^([^\[]*\[[^\]]+\]\s*)/, '').trim();
      cleaned = cleaned.replace(/^([^\p{L}\p{N}]+)?/u, '').trim();
      return escapeHTML(cleaned);
    }

    function formatTaskMessage(text) {
      if (!text) return '';
      return escapeHTML(text.replace(/\s+/g, ' ').trim());
    }

    function formatTimelineDetail(text) {
      if (!text) return '';
      return escapeHTML(stripThinkBlocks(text).replace(/\s+/g, ' ').trim());
    }

    function stripThinkBlocks(text) {
      if (!text) return '';
      return text.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
    }

    function escapeHTML(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderTimeline() {
      const list = document.getElementById('timelineList');
      if (!list) return;
      if (timelineEntries.length === 0) {
        list.innerHTML = `
          <div class="timeline-entry">
            <div class="timeline-icon">‚ÑπÔ∏è</div>
            <div class="timeline-body">
              <div class="timeline-role-label">[System]</div>
              <div class="timeline-text">Timeline will appear as soon as the crew starts collaborating.</div>
            </div>
          </div>
        `;
        return;
      }
      list.innerHTML = timelineEntries.map(entry => renderTimelineBubble(entry)).join('');
    }

    function openTimelineModal() {
      if (!timelineModal) return;
      renderTimelineModal();
      timelineModal.classList.add('visible');
      document.body.style.overflow = 'hidden';
    }

    function closeTimelineModal() {
      if (!timelineModal) return;
      timelineModal.classList.remove('visible');
      document.body.style.overflow = '';
    }

    function renderTimelineModal() {
      if (!timelineModalBody) return;
      if (timelineEntries.length === 0) {
        timelineModalBody.innerHTML = `
          <div class="timeline-entry">
            <div class="timeline-icon">‚ÑπÔ∏è</div>
            <div class="timeline-body">
              <div class="timeline-role-label">[System]</div>
              <div class="timeline-text">Timeline will appear as soon as the crew starts collaborating.</div>
            </div>
          </div>
        `;
        return;
      }
      timelineModalBody.innerHTML = timelineEntries.map(entry => renderTimelineBubble(entry)).join('');
    }

    function renderTimelineBubble(entry) {
      const isActive = activeAgentId && entry.roleId === activeAgentId && entry.type !== 'task';
      return `
        <div class="timeline-entry ${entry.roleId === 'pm' ? 'pm' : ''} ${entry.type === 'task' ? 'task' : ''} ${isActive ? 'active' : ''}">
          <div class="timeline-icon">${entry.icon}</div>
          <div class="timeline-body">
            <div class="timeline-role-label">[${entry.role}]${entry.time ? ` ¬∑ <span class="timeline-time">${entry.time}</span>` : ''}</div>
            <div class="timeline-text">${entry.message}</div>
            ${entry.toolName ? `<div class="timeline-tool-badge">üîß Tool ¬∑ ${entry.toolName}</div>` : ''}
            ${isActive ? `<div class="timeline-thinking">thinking<span></span><span></span><span></span></div>` : ''}
          </div>
        </div>
      `;
    }

    const LONG_TASK_START = [
      'finalizing datasets',
      'generating starter code bundle',
      'applying custom portal styling',
      'finalizing deliverables',
      'assignment generator is crafting'
    ];
    const LONG_TASK_END = [
      'starter code package ready',
      'styling refinements applied',
      'final assets ready',
      'portal ready for candidates',
      'assignments generated'
    ];

    function updateLongTaskBanner(newLogs) {
      if (!newLogs || newLogs.length === 0) return;
      const normalized = newLogs.map(line => line.toLowerCase());

      if (normalized.some(line => LONG_TASK_START.some(keyword => line.includes(keyword)))) {
        let message = 'Finalizing deliverables. This may take a minute‚Ä¶';
        if (normalized.some(line => line.includes('starter code'))) {
          message = 'Generating starter code package‚Ä¶ this can take up to a minute.';
        } else if (normalized.some(line => line.includes('styling'))) {
          message = 'Applying custom portal styling‚Ä¶ almost ready.';
        } else if (normalized.some(line => line.includes('assignment generator is crafting'))) {
          message = 'Assignment Generator is crafting scenario variations‚Ä¶ thank you for waiting.';
        } else if (normalized.some(line => line.includes('finalizing'))) {
          message = 'Finalizing datasets and portal assets‚Ä¶ please keep this tab open.';
        }
        showLongTaskBanner(message);
      }

      if (normalized.some(line => LONG_TASK_END.some(keyword => line.includes(keyword)))) {
        hideLongTaskBanner();
      }
    }

    function showLongTaskBanner(message) {
      if (!longTaskBanner) return;
      longTaskActive = true;
      if (longTaskText) {
        longTaskText.textContent = message || 'Finalizing deliverables. This may take a minute‚Ä¶';
      }
      longTaskBanner.classList.add('visible');
    }

    function hideLongTaskBanner() {
      if (!longTaskBanner) return;
      if (!longTaskActive) return;
      longTaskActive = false;
      longTaskBanner.classList.remove('visible');
    }

    timelineModal?.addEventListener('click', (event) => {
      if (event.target === timelineModal) {
        closeTimelineModal();
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && timelineModal?.classList.contains('visible')) {
        closeTimelineModal();
      }
    });

    // Load recent jobs on page load
    loadRecentJobs();
  </script>
</body>
</html>

